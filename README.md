# Nixerator

NixOS configuration using flakes and home-manager with a modular structure.

## Structure

```
├── flake.nix                 # Main flake configuration
├── settings/
│   └── globals.nix          # Global configuration data
├── lib/
│   ├── mkHost.nix           # Host creation function
│   ├── autoimport.nix       # Reusable auto-import function
│   └── default.nix          # Library exports
├── modules/
│   ├── default.nix          # Auto-imports all modules
│   ├── apps/
│   │   ├── cli/             # CLI applications (git, etc.)
│   │   └── gui/             # GUI applications
│   ├── archetypes/          # Machine profiles (workstation, server)
│   ├── suites/              # Logical groupings (dev, terminal)
│   └── system/              # System configuration (networking, etc.)
└── hosts/
    └── nixerator/
        ├── configuration.nix         # NixOS system configuration
        ├── home.nix                  # Home Manager configuration
        ├── hardware-configuration.nix # Hardware-specific (generated)
        ├── boot.nix                  # Bootloader configuration (machine-specific)
        └── vm.nix                    # VM-specific configuration
```

### Machine-Specific vs Shared Configuration

- **hardware-configuration.nix** - Generated by `nixos-generate-config`, contains hardware detection
- **boot.nix** - Bootloader settings extracted from generated config, varies by machine
- **vm.nix** - VM-specific settings, comment out for bare metal
- **configuration.nix** - Shared configuration using globals, consistent across hosts

## Configuration

Edit global settings in `settings/globals.nix` to set username, timezone, locale, and preferences.

### Architecture

Following Nix best practices, the configuration separates concerns:
- **settings/** - Pure configuration data (globals, secrets, themes)
- **lib/** - Pure functions that operate on data
- **modules/** - Reusable NixOS + Home Manager modules with auto-import
- **hosts/** - Host-specific configuration

This separation ensures clean, maintainable, and testable code.

### Module Organization

Modules are automatically imported via `modules/default.nix`:

- **apps/cli/** - Command-line applications (git, helix, etc.)
- **apps/gui/** - Graphical applications (firefox, vscode, etc.)
- **suites/** - Logical groupings that enable multiple apps (dev, terminal, etc.)
- **archetypes/** - Machine profiles that enable suites (workstation, server, etc.)
- **system/** - System-level configuration (networking, users, etc.)

**To add a new module:**
1. Create a directory in the appropriate category (e.g., `modules/apps/cli/myapp/`)
2. Add a `default.nix` with options pattern (see git module as example)
3. It will be auto-imported - just enable it with `apps.cli.myapp.enable = true;`

**Auto-import exclusions:**
- Modules in `disabled/`, `build/`, or `cfg/` subdirectories are automatically excluded
- Use these folders for work-in-progress or configuration-specific modules

## Common Commands

A `justfile` is provided for common operations:

```bash
just switch          # Rebuild and switch NixOS (includes Home Manager)
just boot            # Rebuild and activate on next boot
just test            # Test configuration temporarily
just build           # Build without activating
just check           # Check flake for errors
just update          # Update all flake inputs
just clean           # Garbage collect old generations
just generations     # List all system generations
just optimize        # Optimize nix store
just search <pkg>    # Search for a package
```

Run `just` to see all available commands.

## VM Dev

The `nixerator` host includes VM-specific configuration in `hosts/nixerator/vm.nix` for development in a libvirt VM.

### Shared Folder Setup

The VM configuration mounts a virtiofs share from the host at `/home/dustin/dev/nix/nixerator`, allowing you to develop on the host and build in the VM.

**Required libvirt XML configuration:**
```xml
<filesystem type="mount" accessmode="passthrough">
  <driver type="virtiofs"/>
  <source dir="/path/on/host"/>
  <target dir="mount_nixerator"/>
</filesystem>
```

**Temporary mount for initial setup:**
```bash
sudo mkdir -p /home/dustin/dev/nix/nixerator
sudo mount -t virtiofs mount_nixerator /home/dustin/dev/nix/nixerator
cd /home/dustin/dev/nix/nixerator
sudo nixos-rebuild switch --flake .#nixerator
```

After the first rebuild, the mount will be permanent and automatically mount on boot.

**For bare metal installation:** Comment out the `./vm.nix` import in `hosts/nixerator/configuration.nix`.

## Setup

### New Install Workflow

For each new machine, capture the machine-specific configuration once:

1. **Generate hardware configuration:**
   ```bash
   nixos-generate-config --show-hardware-config > hosts/nixerator/hardware-configuration.nix
   ```

2. **Update boot configuration:**
   - Check the generated `/etc/nixos/configuration.nix` for bootloader settings
   - Update `hosts/nixerator/boot.nix` with the appropriate bootloader config (GRUB vs systemd-boot)
   - Once set, this rarely needs to change

3. **Adjust machine-specific imports:**
   - Comment out `./vm.nix` in `configuration.nix` if installing to bare metal
   - Keep it enabled for VM development

4. **Build and switch:**
   ```bash
   sudo nixos-rebuild switch --flake .#nixerator
   ```

After initial setup, `hardware-configuration.nix` and `boot.nix` are committed and rarely change. All other configuration is managed through `lib/globals.nix` and host-specific files.

## Alternative Bootstrap (Experimental)

Alternative installation approach inspired by [sweenu/nixfiles](https://github.com/sweenu/nixfiles). Evaluate and adapt as needed.

### Creating Installation ISO

Generate a custom NixOS installation ISO:

```bash
# Using nixos-generators
nixos-generate --flake '.#nixerator' --format iso

# Or build directly
nix build .#nixosConfigurations.nixerator.config.system.build.isoImage
```

Write to USB:
```bash
sudo dd if=result/iso/*.iso of=/dev/sdX bs=4M status=progress
```

### Fresh Installation Steps

Boot from ISO and execute:

```bash
# Clone configuration first
git clone https://github.com/bashfulrobot/nixerator /tmp/nixerator
cd /tmp/nixerator

# Partition and format (adjust for your setup)
sudo parted /dev/sda -- mklabel gpt
sudo parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB
sudo parted /dev/sda -- set 1 esp on
sudo parted /dev/sda -- mkpart primary 512MiB 100%

sudo mkfs.fat -F 32 -n boot /dev/sda1
sudo mkfs.ext4 -L nixos /dev/sda2

# Mount filesystems
sudo mount /dev/disk/by-label/nixos /mnt
sudo mkdir -p /mnt/boot
sudo mount /dev/disk/by-label/boot /mnt/boot

# Generate hardware config
sudo nixos-generate-config --root /mnt --dir /tmp
sudo cp /tmp/hardware-configuration.nix hosts/nixerator/

# Install
sudo nixos-install --flake '.#nixerator' --root /mnt

# Reboot
reboot
```

### Post-Installation Tasks

After first boot:

```bash
# Set user password
passwd

# Update flake inputs
just update

# Rebuild with latest
just switch
```

**Important files to backup:**
- SSH keys (`~/.ssh`)
- Shell history
- NetworkManager configurations (`/etc/NetworkManager/system-connections/`)
- Personal documents and dotfiles

## Credits

- Bootstrap installation approach inspired by [sweenu/nixfiles](https://github.com/sweenu/nixfiles)
- Hyprland desktop environment via [bashfulrobot/hyprflake](https://github.com/bashfulrobot/hyprflake)
