# NixOS Installation Guide for Donkeykong
# Using nixerator flake with disko declarative partitioning

## Prerequisites
- Boot donkeykong from NixOS live USB
- Open a terminal in the live session
- Run all commands as root or with sudo

## Step 1: Verify Internet Connection

# The GUI live session should already be connected to the internet
# Just verify the connection works:
ping -c 3 google.com

## Step 2: Retrieve SSH Keys (for Git authentication)

# Copy SSH keys from existing system to enable SSH git clone
# Only copy actual key files (id_*) with proper permissions
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Copy private keys (id_rsa, id_ed25519, etc.)
scp dustin@192.168.169.4:~/.ssh/id_* ~/.ssh/ 2>/dev/null || true

# Set correct permissions on private keys (must be 600)
chmod 600 ~/.ssh/id_* 2>/dev/null || true

# Copy public keys (id_*.pub)
scp dustin@192.168.169.4:~/.ssh/id_*.pub ~/.ssh/ 2>/dev/null || true

# Set correct permissions on public keys (644)
chmod 644 ~/.ssh/id_*.pub 2>/dev/null || true

## Step 3: Clone the nixerator Repository

# Create a working directory
mkdir -p /tmp/install
cd /tmp/install

# Clone using SSH (now that keys are set up)
nix-shell -p git --run "git clone git@github.com:bashfulrobot/nixerator.git"
cd nixerator

## Step 4: Setup git-crypt (if using encrypted files)

# The nixerator repository supports git-crypt for encrypting sensitive files
# If you have encrypted files, you'll need to unlock the repository

# Copy the git-crypt key from your existing system (same host as SSH keys)
scp dustin@192.168.169.4:~/.ssh/nixerator-git-crypt ~/.ssh/
chmod 600 ~/.ssh/nixerator-git-crypt

# Run the setup script to unlock the repository
# This script uses nix-shell to automatically provide git-crypt and other tools
./extras/helpers/setup-git-crypt.sh

# The script will unlock any encrypted files configured in .gitattributes
# Check git-crypt status to verify
git-crypt status

## Step 5: Verify Disk Configuration

# Check that the disk ID matches what's in disko.nix
ls -l /dev/disk/by-id/ | grep nvme

# The disko.nix is configured for:
# nvme-SAMSUNG_MZVLC1T0HFLU-00BLL_S7SDNF0Y302997

# If the disk ID is different, you'll need to edit hosts/donkeykong/disko.nix
# before proceeding (use nano or vim)

## Step 6: Partition and Format Disk with Disko

# WARNING: This will ERASE ALL DATA on the disk!
# Make absolutely sure you're targeting the correct disk!

# Run disko to partition, format, and set up LUKS encryption
# You will be prompted to create an encryption password - REMEMBER THIS!
# You'll need it every time you boot the system.

sudo nix --experimental-features "nix-command flakes" run github:nix-community/disko -- \
  --mode disko \
  --flake .#donkeykong

# Enter your LUKS encryption password when prompted
# Enter it again to confirm

## Step 7: Generate Hardware Configuration

# Generate hardware config WITHOUT filesystem info (disko handles that)
# Using --no-filesystems flag per disko documentation
sudo nixos-generate-config --root /mnt --no-filesystems

# Review the generated config
cat /mnt/etc/nixos/hardware-configuration.nix

# Copy to repository
sudo cp /mnt/etc/nixos/hardware-configuration.nix ./hosts/donkeykong/

# Commit to git (important for reproducibility!)
git add hosts/donkeykong/hardware-configuration.nix
git commit -m "feat(donkeykong): add hardware configuration"

## Step 8: Install NixOS

# Now install NixOS using the flake configuration
sudo nixos-install --flake .#donkeykong

# This will:
# - Build the system configuration
# - Install all packages
# - Set up the bootloader
# - May take 15-30 minutes depending on internet speed

## Step 9: Copy SSH and GPG Keys to Installed System

# IMPORTANT: Copy keys to the final filesystem BEFORE rebooting
# The live session is ephemeral - keys copied there won't persist

# Copy SSH keys to installed system
sudo mkdir -p /mnt/home/dustin/.ssh
sudo chmod 700 /mnt/home/dustin/.ssh

# Copy private keys (id_rsa, id_ed25519, etc.)
sudo scp dustin@192.168.169.4:~/.ssh/id_* /mnt/home/dustin/.ssh/ 2>/dev/null || true

# Set correct permissions on private keys (must be 600)
sudo chmod 600 /mnt/home/dustin/.ssh/id_* 2>/dev/null || true

# Copy public keys (id_*.pub)
sudo scp dustin@192.168.169.4:~/.ssh/id_*.pub /mnt/home/dustin/.ssh/ 2>/dev/null || true

# Set correct permissions on public keys (644)
sudo chmod 644 /mnt/home/dustin/.ssh/id_*.pub 2>/dev/null || true

# Optional: Copy SSH config if you have one
sudo scp dustin@192.168.169.4:~/.ssh/config /mnt/home/dustin/.ssh/config 2>/dev/null || true
sudo chmod 644 /mnt/home/dustin/.ssh/config 2>/dev/null || true

# Copy git-crypt key to installed system
sudo scp dustin@192.168.169.4:~/.ssh/nixerator-git-crypt /mnt/home/dustin/.ssh/
sudo chmod 600 /mnt/home/dustin/.ssh/nixerator-git-crypt

# Copy GPG keys to installed system
sudo mkdir -p /mnt/home/dustin/.gnupg
sudo chmod 700 /mnt/home/dustin/.gnupg
sudo scp -r dustin@192.168.169.4:~/.gnupg/* /mnt/home/dustin/.gnupg/ 2>/dev/null || true
sudo chmod 600 /mnt/home/dustin/.gnupg/* 2>/dev/null || true

# Copy nixerator repository to final location
sudo mkdir -p /mnt/home/dustin/dev/nix
sudo cp -r /tmp/install/nixerator /mnt/home/dustin/dev/nix/

# Create post-install script to fix permissions after reboot
# (Cannot chown now - user doesn't exist yet during installation)
sudo tee /mnt/home/dustin/post-install.sh > /dev/null << 'EOF'
#!/usr/bin/env bash
# Post-installation permission fix script
# Run this after first boot to fix file ownership

echo "Fixing file permissions and ownership..."

# Fix SSH keys ownership
sudo chown -R dustin:users ~/.ssh
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_* 2>/dev/null || true
chmod 644 ~/.ssh/id_*.pub 2>/dev/null || true
chmod 644 ~/.ssh/config 2>/dev/null || true
chmod 600 ~/.ssh/nixerator-git-crypt 2>/dev/null || true

# Fix GPG keys ownership
sudo chown -R dustin:users ~/.gnupg
chmod 700 ~/.gnupg
find ~/.gnupg -type f -exec chmod 600 {} \;

# Fix repository ownership
sudo chown -R dustin:users ~/dev

# Restart GPG agent with correct permissions
gpgconf --kill gpg-agent
gpg --list-keys

echo "âœ… Permissions fixed! You can now use SSH and GPG."
echo "Removing this script..."
rm ~/post-install.sh
EOF

sudo chmod +x /mnt/home/dustin/post-install.sh

## Step 10: Set Root Password

# During installation, you'll be prompted to set the root password
# If not, or if you need to change it:

sudo nixos-enter --root /mnt -c 'passwd root'

## Step 11: Set User Password

# Set password for your user (dustin)
sudo nixos-enter --root /mnt -c 'passwd dustin'

## Step 12: Reboot

# Unmount and reboot
sudo umount -R /mnt
sudo reboot

# Remove the USB drive when the system restarts

## Step 13: First Boot

# On first boot:
# 1. You'll see the systemd-boot menu
# 2. Select the default NixOS option
# 3. You'll be prompted for your LUKS encryption password
# 4. Enter the password you created in Step 5
# 5. System will boot and show GDM login screen
# 6. Log in with user 'dustin' and the password from Step 8

## Post-Installation

# After successfully booting and logging in:

# 1. Fix file permissions and ownership
# Run the post-install script created during installation
~/post-install.sh

# This script will:
# - Fix SSH key ownership and permissions
# - Fix GPG key ownership and permissions
# - Fix repository ownership
# - Restart GPG agent
# - Remove itself when done

# 2. Verify SSH and GPG keys work
ssh-add -l
gpg --list-keys
git config --global user.signingkey  # Verify signing key

# 3. Test SSH to GitHub
ssh -T git@github.com

# 4. Verify git-crypt is working (if using encrypted files)
cd ~/dev/nix/nixerator
git-crypt status  # Check encryption status

# 5. Verify nixerator repository
git status

# 6. Verify system is working
neofetch
hyprctl version

# 7. Update flake inputs if needed
nix flake update

# 8. Rebuild after changes
sudo nixos-rebuild switch --flake ~/dev/nix/nixerator#donkeykong

## Troubleshooting

# If disko fails:
# - Verify disk ID matches: ls -l /dev/disk/by-id/
# - Check disk isn't mounted: lsblk
# - Unmount if needed: sudo umount /mnt/*
# - Close LUKS if exists: sudo cryptsetup close cryptroot

# If installation fails:
# - Check internet connection
# - Verify flake.lock is present in repo
# - Try: nix flake metadata .#donkeykong to test flake

# If boot fails:
# - Double-check LUKS password
# - Boot from live USB and check /boot/loader/entries/
# - Verify ESP partition is properly mounted

# If git-crypt unlock fails (when using encrypted files):
# - Verify key exists: ls -l ~/.ssh/nixerator-git-crypt
# - Check key permissions: should be 600 (rw-------)
# - Re-run setup script: ./extras/helpers/setup-git-crypt.sh
# - Manual unlock: git-crypt unlock ~/.ssh/nixerator-git-crypt

## Important Files

# Configuration: hosts/donkeykong/configuration.nix
# Disk layout: hosts/donkeykong/disko.nix
# Boot config: hosts/donkeykong/boot.nix
# Home-manager: hosts/donkeykong/home.nix

## System Specifications

# Host: donkeykong
# Disk: Samsung NVMe 1TB SSD
# Encryption: LUKS (cryptroot)
# Filesystem: ext4 with LVM
# Swap: 32GB (for hibernation)
# RAM: 32GB
# Desktop: Hyprland (via hyprflake)
# Boot: systemd-boot (UEFI)
