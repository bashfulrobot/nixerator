# AMD GPU Suspend/Resume Troubleshooting - qbert

## Problem
Monitor does not turn on after system sleep/hibernate. Requires hard power down and reboot to restore display.

## Hardware
- AMD RDNA2/3 GPU (RX 6000/7000 series based on logs)
- Host: qbert
- Kernel: 6.18.3-zen1

## Root Cause Analysis

### Logs Examined
Date: 2026-01-07
Boot: -1 (previous boot before hard reset)

### Key Error Messages
```
amdgpu 0000:28:00.0: amdgpu: suspend of IP block <smu> failed -22
amdgpu 0000:28:00.0: amdgpu: resume of IP block <smu> failed -62
PM: Some devices failed to suspend, or early wake event detected
```

**Diagnosis**: SMU (System Management Unit) failing during suspend/resume cycle. This is a known issue with AMD RDNA2/3 GPUs where the Bus Active Chip Off (BACO) runtime power management causes the SMU to fail when entering/exiting deep sleep states.

### GPU Info from Logs
- Device: amdgpu 0000:28:00.0
- BIOS: ATOM BIOS: 113-V395TRIO-1OC
- VRAM: 16368M GDDR6
- Firmware: SMU fw version 0x003a5a00 (58.90.0)
- Runtime PM: Using BACO for runtime pm (this is the problem!)

## Solutions Attempted

### 1. GFXOFF Disable (FAILED)
**Date**: commit 9274e2b
**Configuration**:
```nix
boot.kernelParams = [
  "amdgpu.ppfeaturemask=0xffff7fff"  # Disable GFXOFF
];
```
**Result**: Did not resolve the issue. Monitor still failed to wake.
**Status**: Reverted in current working tree

### 2. Runtime PM Disable (CURRENT)
**Date**: 2026-01-07
**Configuration**:
```nix
boot.kernelParams = [
  "amdgpu.runpm=0"  # Disable runtime power management (BACO)
];
```
**Rationale**: Directly addresses the BACO/SMU failure by preventing the GPU from entering deep runtime power states that cause the SMU to fail.
**Status**: TESTING - needs rebuild, reboot, and verification

## Testing Procedure

After rebuilding and rebooting with new configuration:

1. Check kernel parameter is active:
   ```bash
   cat /proc/cmdline | grep amdgpu
   ```

2. Trigger suspend:
   ```bash
   systemctl suspend
   ```

3. Wake system (keyboard/mouse)

4. Verify monitor turns on

5. Check logs for errors:
   ```bash
   journalctl --boot=-0 | grep -i "amdgpu.*suspend\|amdgpu.*resume\|PM:"
   ```

6. Look for absence of SMU errors

## Alternative Options (If Current Solution Fails)

### Option A: Force S3 Deep Sleep
**Configuration**:
```nix
boot.kernelParams = [
  "amdgpu.runpm=0"
  "mem_sleep=deep"  # Force traditional ACPI S3 instead of s2idle
];
```
**Rationale**: Modern s2idle (suspend-to-idle) may not be fully supported by motherboard/GPU combination. Traditional S3 has better hardware support.
**Tradeoff**: Not all systems support S3 deep sleep on modern platforms.

### Option B: Disable Display Power Management
**Configuration**:
```nix
boot.kernelParams = [
  "amdgpu.runpm=0"
  "amdgpu.dc=1"     # Ensure Display Core is enabled
  "amdgpu.dpm=0"    # Disable dynamic power management
];
```
**Rationale**: Prevents GPU from dynamically adjusting power states that may interfere with display.
**Tradeoff**: Higher idle power consumption, potentially higher temps.

### Option C: Conservative Power Management
**Configuration**:
```nix
boot.kernelParams = [
  "amdgpu.runpm=0"
  "amdgpu.gfxoff=0"     # Disable graphics power gating
  "amdgpu.ppfeaturemask=0xffff7fff"  # Disable PP_GFXOFF_MASK
];
```
**Rationale**: Combination approach disabling multiple power-saving features.
**Tradeoff**: Highest power consumption, but most comprehensive fix.

### Option D: Firmware Workaround
**Configuration**:
```nix
boot.kernelParams = [
  "amdgpu.runpm=0"
  "amdgpu.noretry=1"    # Disable retry on errors
  "initcall_blacklist=amdgpu_init"  # Last resort: late GPU init
];
```
**Rationale**: Changes initialization order or error handling.
**Tradeoff**: May cause other issues, use only as last resort.

### Option E: Display Manager Workarounds
If kernel parameters don't work, investigate display manager suspend hooks:

For Hyprland (currently in use based on logs):
- Configure `hypridle` to execute dpms commands before/after suspend
- Add pre-suspend script to dump display state
- Add post-resume script to reinitialize displays

Config location: Check hypridle configuration for suspend/resume hooks

## NixOS Hardware Options Available

Limited `hardware.amdgpu.*` options in NixOS:
```nix
hardware.amdgpu.overdrive.ppfeaturemask  # Overclocking related
hardware.amdgpu.overdrive.enable
hardware.amdgpu.opencl.enable
hardware.amdgpu.legacySupport.enable
hardware.amdgpu.initrd.enable            # Already enabled in gpu.nix
```

Source: https://raw.githubusercontent.com/NixOS/nixpkgs/refs/heads/nixos-unstable/nixos/modules/services/hardware/amdgpu.nix

**Note**: Most runtime power management must be configured via `boot.kernelParams` rather than NixOS hardware options.

## References

- ArchWiki AMDGPU: https://wiki.archlinux.org/title/AMDGPU
- Kernel parameters: Documentation/gpu/amdgpu/module-parameters.txt
- SMU (System Management Unit): Firmware component managing GPU power states
- BACO (Bus Active Chip Off): PCIe power state causing the issue

## Current Configuration File

Location: `hosts/qbert/gpu.nix`

Full configuration as of 2026-01-07:
```nix
{ pkgs, ... }:

# AMD GPU Configuration for qbert
# Based on previous qbert configuration from nixcfg-main

{
  # Load AMDGPU driver in initramfs
  boot.initrd.kernelModules = [ "amdgpu" ];

  # Hardware configuration for AMD GPU
  hardware = {
    # Enable graphics hardware acceleration
    graphics = {
      enable = true;
      enable32Bit = true;  # Required for 32-bit applications and games
    };

    # Load AMDGPU driver early for proper resolution during boot
    amdgpu.initrd.enable = true;

    # Ensure firmware is available for GPU
    firmware = [ pkgs.linux-firmware ];
  };

  # Fix for monitor not waking after sleep/suspend
  # Disable runtime PM (BACO) which causes SMU suspend/resume failures
  # Error: "suspend of IP block <smu> failed -22"
  boot.kernelParams = [
    "amdgpu.runpm=0"  # Disable runtime power management (BACO)
  ];

  # OpenCL support for compute tasks (uncomment if needed)
  # hardware.amdgpu.opencl.enable = true;

  # LACT - Linux AMDGPU Controller Tool (uncomment if needed)
  # Provides GUI for overclocking, undervolting, fan curves
  # services.lact.enable = true;
}
```

## Next Steps

1. Rebuild: `sudo nixos-rebuild switch`
2. Reboot: `sudo reboot`
3. Test suspend/resume cycle
4. Document results
5. If successful, commit changes
6. If unsuccessful, try Option A (S3 deep sleep) next
